(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[953],{3955:(e,t,r)=>{"use strict";r.d(t,{CommentsSection:()=>c});var n=r(413),o=r(3353);let s="https://takayama-api.masayuki.workers.dev".replace(/\/$/,"");function i(e){let t=function(){if(!s)throw Error("NEXT_PUBLIC_API_BASE_URL が設定されていません");return s}();return"".concat(t).concat(e)}async function l(e){let t=await fetch(i("/api/comments?slug=".concat(encodeURIComponent(e))),{cache:"no-store"});if(!t.ok)throw Error("Failed to fetch comments (".concat(t.status,")"));return t.json()}async function a(e,t){let r=await fetch(i("/api/comments?slug=".concat(encodeURIComponent(e))),{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({body:t})});if(!r.ok){let{error:e}=await r.json().catch(()=>({error:"投稿に失敗しました"}));throw Error(null!=e?e:"Failed to post comment")}}function c(e){let{slug:t,initialComments:r}=e,[s,i]=(0,o.useState)(r),[c,m]=(0,o.useState)(null),[u,h]=(0,o.useState)("idle"),[p,y]=(0,o.useTransition)();(0,o.useEffect)(()=>{i(r)},[r]);let b=s.length>0,f=async e=>{0;h("submitting"),m(null);try{await a(t,e),h("success"),await l(t).then(e=>i(e.comments))}catch(e){throw console.error("[comments] post failed",e),m(e instanceof Error?e.message:"投稿に失敗しました"),h("error"),e}},g=(0,o.useMemo)(()=>"success"===u?"投稿が完了しました。反映まで数秒かかる場合があります。":"error"===u&&c?c:void 0,[u,c]);return(0,n.jsxs)("section",{style:{marginTop:"4rem"},children:[(0,n.jsxs)("header",{style:{marginBottom:"1.5rem"},children:[(0,n.jsx)("h2",{style:{fontSize:"1.5rem",fontWeight:600},children:"コメント"}),(0,n.jsx)("p",{style:{color:"#6b7280",fontSize:"0.9rem"},children:"認証なしで投稿できます。公序良俗に反する内容は削除対象となります。"}),null]}),(0,n.jsx)(d,{onSubmit:f,isSubmitting:"submitting"===u,disabled:!1,hint:g}),(0,n.jsxs)("div",{style:{marginTop:"2rem"},children:[p?(0,n.jsx)("p",{children:"再読込中..."}):null,b?(0,n.jsx)("ul",{style:{listStyle:"none",padding:0,margin:0,display:"grid",gap:"1.5rem"},children:s.map(e=>(0,n.jsxs)("li",{style:{border:"1px solid #e5e7eb",borderRadius:"0.75rem",padding:"1.25rem"},children:[(0,n.jsx)("p",{style:{marginBottom:"0.75rem",color:"#111827"},children:e.body}),(0,n.jsx)("time",{dateTime:new Date(1e3*e.createdAt).toISOString(),style:{display:"block",fontSize:"0.85rem",color:"#6b7280"},children:new Date(1e3*e.createdAt).toLocaleString("ja-JP")})]},e.id))}):(0,n.jsx)("p",{style:{color:"#6b7280"},children:"まだコメントはありません。最初の感想をシェアしましょう。"})]}),(0,n.jsx)("button",{type:"button",onClick:()=>{0;y(async()=>{try{let e=await l(t);i(e.comments),m(null)}catch(e){console.error("[comments] refresh failed",e),m("コメントの取得に失敗しました")}})},disabled:!1,style:{marginTop:"1.5rem",padding:"0.5rem 1rem",borderRadius:"0.5rem",border:"1px solid #e5e7eb",cursor:"pointer",opacity:1},children:"最新のコメントを取得"})]})}function d(e){let{onSubmit:t,isSubmitting:r,disabled:s=!1,hint:i}=e,[l,a]=(0,o.useState)(""),[c,d]=(0,o.useState)(null),m=async e=>{e.preventDefault();let r=l.trim();if(r.length<5)return void d("5文字以上で入力してください");d(null);try{await t(r),a("")}catch(e){d(e instanceof Error?e.message:"投稿に失敗しました")}};return(0,n.jsxs)("form",{onSubmit:m,style:{display:"grid",gap:"0.75rem"},children:[(0,n.jsx)("label",{htmlFor:"comment-body",style:{fontWeight:500},children:"コメント本文"}),(0,n.jsx)("textarea",{id:"comment-body",name:"body",value:l,onChange:e=>a(e.target.value),rows:4,style:{width:"100%",border:"1px solid #d1d5db",borderRadius:"0.75rem",padding:"0.75rem",fontSize:"1rem",resize:"vertical"},placeholder:"投稿への感想や質問などを記入してください",disabled:r||s}),(0,n.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"0.75rem"},children:[(0,n.jsx)("button",{type:"submit",disabled:r||s,style:{backgroundColor:"#111827",color:"#fff",border:"none",borderRadius:"0.75rem",padding:"0.6rem 1.2rem",cursor:r||s?"not-allowed":"pointer",opacity:r||s?.6:1},children:r?"送信中...":"コメントを投稿"}),i?(0,n.jsx)("p",{style:{fontSize:"0.85rem",color:"#6b7280"},children:i}):null]}),c?(0,n.jsx)("p",{style:{color:"#dc2626",fontSize:"0.9rem"},children:c}):null]})}},6527:(e,t,r)=>{Promise.resolve().then(r.t.bind(r,8541,23)),Promise.resolve().then(r.bind(r,3955))}},e=>{e.O(0,[541,613,299,358],()=>e(e.s=6527)),_N_E=e.O()}]);